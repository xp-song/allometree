<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Get started with allometree • allometree</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Get started with allometree">
<meta property="og:description" content="allometree">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">allometree</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/allometree.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xp-song/allometree/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Get started with allometree</h1>
            
            <h4 class="date">2020-05-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xp-song/allometree/blob/master/vignettes/allometree.Rmd"><code>vignettes/allometree.Rmd</code></a></small>
      <div class="hidden name"><code>allometree.Rmd</code></div>

    </div>

    
    
<p>The <code>allometree</code> package enables you to develop and use allometric equations relating to the size and structure of urban trees. For example, these equations have been used to predict trunk diameter from tree age, as well as to predict tree height, crown height, crown diameter and leaf area from trunk diameter (McPherson <em>et al.</em>, 2016). They are foundational to other models that estimate the benefits and hazards associated with trees as they mature and grow in size. More information can be found in Song <em>et al.</em> (in prep).</p>
<p>This document demonstrates the workflow to develop these allometric models, taking the relationship between two size parameters as an example: Predicting tree <em>height</em> from trunk <em>diameter</em>.</p>
<p>Two modelling approaches will be introduced:</p>
<ol style="list-style-type: decimal">
<li>Linear regression models developed separately for each species, i.e., <em>single-species models</em>
</li>
<li>A linear mixed-effects model that includes all species as random effects, i.e., <em>mixed-effects model</em>
</li>
</ol>
<div id="example-data-urbantrees" class="section level2">
<h2 class="hasAnchor">
<a href="#example-data-urbantrees" class="anchor"></a>Example data: <code>urbantrees</code>
</h2>
<p>We will be using <code><a href="https://rdrr.io/r/utils/data.html">data(urbantrees)</a></code>. It contains five species planted along streets in Singapore. 100 individuals were sampled per species, spanning a wide range of heights and diameter sizes (in metres).</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">urbantrees</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"allometree"</span>)
<span class="no">urbantrees</span>
<span class="co">#&gt; # A tibble: 500 x 3</span>
<span class="co">#&gt; # Groups:   species [5]</span>
<span class="co">#&gt;    species       diameter height</span>
<span class="co">#&gt;    &lt;chr&gt;            &lt;dbl&gt;  &lt;int&gt;</span>
<span class="co">#&gt;  1 Albizia saman    1.53      19</span>
<span class="co">#&gt;  2 Albizia saman    0.859     20</span>
<span class="co">#&gt;  3 Albizia saman    0.675     10</span>
<span class="co">#&gt;  4 Albizia saman    0.831     15</span>
<span class="co">#&gt;  5 Albizia saman    0.939     15</span>
<span class="co">#&gt;  6 Albizia saman    0.458     12</span>
<span class="co">#&gt;  7 Albizia saman    1.22      17</span>
<span class="co">#&gt;  8 Albizia saman    0.882     15</span>
<span class="co">#&gt;  9 Albizia saman    0.834     10</span>
<span class="co">#&gt; 10 Albizia saman    0.477     12</span>
<span class="co">#&gt; # … with 490 more rows</span>

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">urbantrees</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">diameter</span>, <span class="no">height</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">species</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>()</pre></body></html></div>
<p><img src="allometree_files/figure-html/load%20data-1.png" width="528" style="display: block; margin: auto;"></p>
</div>
<div id="allometric-equations-eqns_info" class="section level2">
<h2 class="hasAnchor">
<a href="#allometric-equations-eqns_info" class="anchor"></a>Allometric equations: <code>eqns_info</code>
</h2>
<p>Allometric relationships for urban trees can vary drastically from those for forest trees, and are also influenced by human factors such as pruning and fertilisation. Empirical models are developed using six allometric equations used for urban trees (McPherson <em>et al.</em>, 2016).</p>
<p>More information can be found in <code>?eqns_info</code>, as well as in <code><a href="https://rdrr.io/r/utils/data.html">data(eqns_info)</a></code>. The column <code>modelcode</code> shows the unique model code for each equation:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">eqns_info</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"allometree"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">eqns_info</span>)
<span class="co">#&gt;   modeltype    base_equation   base_formula      weights modelcode</span>
<span class="co">#&gt; 1    Linear       y = a + bx          y ~ x                 lin_w1</span>
<span class="co">#&gt; 2    Linear       y = a + bx          y ~ x I(1/sqrt(x))    lin_w2</span>
<span class="co">#&gt; 3    Linear       y = a + bx          y ~ x       I(1/x)    lin_w3</span>
<span class="co">#&gt; 4    Linear       y = a + bx          y ~ x     I(1/x^2)    lin_w4</span>
<span class="co">#&gt; 5 Quadratic y = a + bx + x^2 y ~ x + I(x^2)                quad_w1</span>
<span class="co">#&gt; 6 Quadratic y = a + bx + x^2 y ~ x + I(x^2) I(1/sqrt(x))   quad_w2</span></pre></body></html></div>
<hr>
</div>
<div id="single-species-models" class="section level2">
<h2 class="hasAnchor">
<a href="#single-species-models" class="anchor"></a>1. Single-species models</h2>
<div id="model-selection" class="section level3">
<h3 class="hasAnchor">
<a href="#model-selection" class="anchor"></a>1.1. Model selection</h3>
<div id="for-one-species" class="section level4">
<h4 class="hasAnchor">
<a href="#for-one-species" class="anchor"></a>For one species</h4>
<p>For a particular species of interest, data will be fit to all allometric equations. The best-fit model is selected based on the lowest bias-corrected Aikaike’s information criterion (AICc) value. Here’s an example to select the best-fit model for the species <em>Albizia saman</em>, using the function <code>sp_modelselect()</code>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">Alb_sam</span> <span class="kw">&lt;-</span> <span class="no">urbantrees</span>[<span class="no">urbantrees</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Albizia saman"</span>, ]  <span class="co"># subset data for one species</span>

<span class="no">results</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelselect</span>(<span class="no">Alb_sam</span>,
                          <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)  <span class="co"># specify colnames of variables</span></pre></body></html></div>
<p>The <code>results</code> variable is a list of 3 elements:</p>
<ol style="list-style-type: decimal">
<li>Table showing models ranked by AICc value, named <code>all_models_rank</code>.</li>
<li>Best-fit model object, named <code>best_model</code>.</li>
<li>Table showing information on the best-fit model, named <code>best_model_info</code>. More information on the output columns can be found at <code>?sp_modelselect</code>.</li>
</ol>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">results</span>$<span class="no">all_models_rank</span>)
<span class="co">#&gt;   df     AICc    model</span>
<span class="co">#&gt; 1  4 450.5618  quad_w1</span>
<span class="co">#&gt; 2  4 451.3031  quad_w2</span>
<span class="co">#&gt; 3  3 451.3991   lin_w2</span>
<span class="co">#&gt; 4  3 451.7529   lin_w1</span>
<span class="co">#&gt; 5  6 452.0554 quart_w1</span>
<span class="co">#&gt; 6  5 452.2919   cub_w1</span></pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">results</span>$<span class="no">best_model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = data[[response]] ~ data[[predictor]] + I(data[[predictor]]^2))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;            (Intercept)       data[[predictor]]  I(data[[predictor]]^2)  </span>
<span class="co">#&gt;                  2.741                  19.664                  -6.061</span></pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">results</span>$<span class="no">best_model_info</span>
<span class="co">#&gt;   modelcode        a        b         c  d  e response_geom_mean</span>
<span class="co">#&gt; 1   quad_w1 2.740553 19.66429 -6.061372 NA NA           13.45471</span>
<span class="co">#&gt;   correctn_factor predictor_min predictor_max residual_SE mean_SE adj_R2   n</span>
<span class="co">#&gt; 1               1     0.3119437      1.527887      2.2412  4.8721 0.4499 100</span></pre></body></html></div>
</div>
<div id="for-multiple-species" class="section level4">
<h4 class="hasAnchor">
<a href="#for-multiple-species" class="anchor"></a>For multiple species</h4>
<p>We can also run <code>sp_modelselect()</code> across multiple species in the full dataset <code>urbantrees</code>. For this, we use the wrapper function <code>sp_modelselect_multi()</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">results_all</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelselect_multi</span>(<span class="no">urbantrees</span>, <span class="kw">species</span> <span class="kw">=</span> <span class="st">"species"</span>, <span class="co"># specify colname of species</span>
                                    <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)</pre></body></html></div>
<p>The <code>results_all</code> variable is a list of 3 elements:</p>
<ol style="list-style-type: decimal">
<li>List of tables showing each species’ candidate models ranked by AICc value, named <code>sp_models_rank</code>.</li>
<li>List of each species’ best-fit model object, named <code>sp_models</code>.</li>
<li>Table showing each species’ best-fit model information, named <code>sp_models_info</code>.</li>
</ol>
<p> </p>
<p><code>results_all$sp_models_info</code> provides a good overview of the best-fit models across the multiple species:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">results_all</span>$<span class="no">sp_models_info</span>
<span class="co">#&gt;                    species modelcode         a           b            c</span>
<span class="co">#&gt; 1            Albizia saman   quad_w1  2.740553  19.6642893    -6.061372</span>
<span class="co">#&gt; 2            Hopea odorata  quart_w4 -4.574237 279.2780006 -3105.195599</span>
<span class="co">#&gt; 3     Syzygium myrtifolium  quart_w2 -9.743595 275.2010554 -1580.335018</span>
<span class="co">#&gt; 4       Terminalia mantaly    cub_w3  3.730866   0.1733303   129.908835</span>
<span class="co">#&gt; 5 Xanthostemon chrysanthus   quad_w1  2.033997  32.4645629   -36.346261</span>
<span class="co">#&gt;            d          e response_geom_mean correctn_factor predictor_min</span>
<span class="co">#&gt; 1         NA         NA          13.454710               1    0.31194369</span>
<span class="co">#&gt; 2 15516.9602 -26692.934           5.354806               1    0.03183099</span>
<span class="co">#&gt; 3  3917.9761  -3398.366           8.037675               1    0.07321127</span>
<span class="co">#&gt; 4  -155.1424         NA           7.609798               1    0.03501409</span>
<span class="co">#&gt; 5         NA         NA           5.106066               1    0.04456338</span>
<span class="co">#&gt;   predictor_max residual_SE mean_SE adj_R2   n</span>
<span class="co">#&gt; 1     1.5278875      2.2412  4.8721 0.4499 100</span>
<span class="co">#&gt; 2     0.2864789     12.5967  2.9191 0.6010 100</span>
<span class="co">#&gt; 3     0.5188451      2.2546  2.4289 0.4341 100</span>
<span class="co">#&gt; 4     0.5602254      3.9638  3.1954 0.7588 100</span>
<span class="co">#&gt; 5     0.3501409      1.1312  1.2413 0.5887 100</span></pre></body></html></div>
</div>
</div>
<div id="outlier-removal" class="section level3">
<h3 class="hasAnchor">
<a href="#outlier-removal" class="anchor"></a>1.2. Outlier removal</h3>
<p>Let’s say we want to check for outlier/influential data points, remove them, and re-fit the filtered dataset to the pre-selected models as defined in <code>results_all$sp_models_info</code>. First, lets visualise these outliers, say, for the species <em>Hopea odorata</em>.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">2</span>)); <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">results_all</span>$<span class="no">sp_models</span>$<span class="no">`Hopea odorata`</span>)</pre></body></html></div>
<p><img src="allometree_files/figure-html/unnamed-chunk-7-1.png" width="528" style="display: block; margin: auto;">  </p>
<p>There are numerous ways to <a href="http://r-statistics.co/Outlier-Treatment-With-R.html">deal with outliers</a>. One way is to remove them based on Cook’s Distance (bottom-right plot). In general use, observations with a Cook’s distance &gt; 4 times the mean may be classified as influential, as shown in the plot below:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">cooks_dist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">cooks.distance</a></span>(<span class="no">results_all</span>$<span class="no">sp_models</span>$<span class="no">`Hopea odorata`</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">cooks_dist</span>, <span class="kw">pch</span> <span class="kw">=</span> <span class="st">"."</span>, <span class="kw">cex</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="st">"Outliers by Cook's Distance"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="fl">4</span>*<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">T</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>)  <span class="co"># threshold line</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">cooks_dist</span>) + <span class="fl">1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cooks_dist</span>,
     <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">cooks_dist</span> <span class="kw">&gt;</span> <span class="fl">4</span> * <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="no">T</span>), <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">cooks_dist</span>), <span class="st">""</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>)  <span class="co"># outlier labels</span></pre></body></html></div>
<p><img src="allometree_files/figure-html/unnamed-chunk-8-1.png" width="384" style="display: block; margin: auto;"></p>
<p> </p>
<p>Here are the outliers for <em>Hopea odorata</em> in our dataset <code>urbantrees</code>:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">outliers</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">cooks_dist</span>)[(<span class="no">cooks_dist</span> <span class="kw">&gt;</span> <span class="fl">4</span> * <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="no">T</span>))])  <span class="co"># influential row numbers</span>
<span class="no">urbantrees</span>[(<span class="no">urbantrees</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Hopea odorata"</span>),][<span class="no">outliers</span>,]
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt; # Groups:   species [1]</span>
<span class="co">#&gt;   species       diameter height</span>
<span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1 Hopea odorata   0.286       2</span>
<span class="co">#&gt; 2 Hopea odorata   0.0318      2</span></pre></body></html></div>
<p>We can create a function <code>uncooker()</code> that removes outliers in the dataset <code>urbantrees</code>, based on the best-fit model for each species (<code>sp_models</code>):</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">uncooker</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">modellist</span>, <span class="no">data</span>){

  <span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">data</span>[<span class="fl">0</span>,]

  <span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">modellist</span>)){ <span class="co"># loop over all species </span>

    <span class="no">cooks_dist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">cooks.distance</a></span>(<span class="no">modellist</span><span class="kw">[[</span><span class="no">i</span>]])
    <span class="no">outliers</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">cooks_dist</span>)[(<span class="no">cooks_dist</span> <span class="kw">&gt;</span> <span class="fl">4</span> * <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">T</span>))])
    <span class="no">subset</span> <span class="kw">&lt;-</span> <span class="no">data</span>[(<span class="no">data</span>$<span class="no">species</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">modellist</span>[<span class="no">i</span>])),][-<span class="no">outliers</span>,]
    <span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind.data.frame</a></span>(<span class="no">result</span>, <span class="no">subset</span>)
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">result</span>)
}

<span class="co"># run the function uncooker()</span>
<span class="no">urbantrees_clean</span> <span class="kw">&lt;-</span> <span class="fu">uncooker</span>(<span class="no">results_all</span>$<span class="no">sp_models</span>, <span class="no">urbantrees</span>)
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">urbantrees_clean</span>)
<span class="co">#&gt; [1] 483</span></pre></body></html></div>
<p> </p>
<p>The filtered dataset <code>urbantrees_clean</code> (n = 483) has 17 less trees than <code>urbantrees</code> (n = 500).</p>
</div>
<div id="re-fit-filtered-data" class="section level3">
<h3 class="hasAnchor">
<a href="#re-fit-filtered-data" class="anchor"></a>1.3. Re-fit filtered data</h3>
<div id="for-one-species-1" class="section level4">
<h4 class="hasAnchor">
<a href="#for-one-species-1" class="anchor"></a>For one species</h4>
<p>We can now fit the filtered data to the best-fit equations we defined in Section 1.1. Here’s an example for the species <em>Albizia saman</em> again, using the function <code>sp_modelfit()</code>.</p>
<p>This function has an additional argument <code>modelcode</code>. In the case of <em>Albizia saman</em>, it is <code>quad_w1</code> (see <code>results_all$sp_models_info</code>). Note that you can also pick any one of the options found in <code>eqns_info$modelcode</code>.</p>
<p>We’ll overwrite our previously-defined variables, this time with the filtered dataset:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">Alb_sam</span> <span class="kw">&lt;-</span> <span class="no">urbantrees_clean</span>[<span class="no">urbantrees_clean</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Albizia saman"</span>, ]

<span class="no">results</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelfit</span>(<span class="no">Alb_sam</span>, <span class="kw">modelcode</span> <span class="kw">=</span> <span class="st">"quad_w1"</span>, <span class="co"># specify modelcode</span>
                       <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)</pre></body></html></div>
<p>The new <code>results</code> variable is a list of 2 elements:</p>
<ol style="list-style-type: decimal">
<li>Resulting model object, named <code>fitted_model</code>.</li>
<li>Table showing information on the resulting model, named <code>fitted_model_info</code>.</li>
</ol>
</div>
<div id="for-multiple-species-1" class="section level4">
<h4 class="hasAnchor">
<a href="#for-multiple-species-1" class="anchor"></a>For multiple species</h4>
<p>Similar to the the wrapper function <code>sp_modelselect_multi()</code>, we can also run <code>sp_modelfit_multi()</code> to fit pre-selected models across multiple species. In this function, we need to input a reference table <code>ref_table</code> (e.g. <code>results_all$sp_models_info</code>) that provides information on the <code>species</code> and their corresponding <code>modelcode</code>.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">results_all</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelfit_multi</span>(<span class="no">urbantrees_clean</span>,
                                 <span class="kw">ref_table</span> <span class="kw">=</span> <span class="no">results_all</span>$<span class="no">sp_models_info</span>,
                                 <span class="kw">species</span> <span class="kw">=</span> <span class="st">"species"</span>, <span class="co"># colname in both data &amp; ref_table</span>
                                 <span class="kw">modelcode</span> <span class="kw">=</span> <span class="st">"modelcode"</span>, <span class="co"># colname in ref_table</span>
                                 <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)</pre></body></html></div>
<p>The new <code>results_all</code> variable is a list of 2 elements:</p>
<ol style="list-style-type: decimal">
<li>List of each species’ resulting model object, named <code>sp_models</code>.</li>
<li>Table showing each species’ resulting model information, named <code>sp_models_info</code>.</li>
</ol>
<p> </p>
<p>To make our subsequent code less verbose, let’s assign the elements <code>sp_models</code> and <code>sp_models_info</code> to variables with the same name:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">sp_models</span> <span class="kw">&lt;-</span> <span class="no">results_all</span>$<span class="no">sp_models</span>
<span class="no">sp_models_info</span> <span class="kw">&lt;-</span> <span class="no">results_all</span>$<span class="no">sp_models_info</span></pre></body></html></div>
</div>
</div>
<div id="make-predictions" class="section level3">
<h3 class="hasAnchor">
<a href="#make-predictions" class="anchor"></a>1.4. Make predictions</h3>
<p>In the works…</p>
<hr>
</div>
</div>
<div id="mixed-effects-model" class="section level2">
<h2 class="hasAnchor">
<a href="#mixed-effects-model" class="anchor"></a>2. Mixed-effects model</h2>
<div id="model-selection-1" class="section level3">
<h3 class="hasAnchor">
<a href="#model-selection-1" class="anchor"></a>2.1. Model selection</h3>
<p>In the works…</p>
<hr>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>McPherson E. G., van Doorn N. S. &amp; Peper P. J. (2016) Urban Tree Database and Allometric Equations. <em>General Technical Report PSW-GTR-253, USDA Forest Service</em>, 86.</p>
<p>Song, X. P., Lai, H. R., Wijedasa, L. S., Yee, A. T. K., Tan, P. Y., Richards, D. R., Streamlining management practices based on the size allometry of tropical street trees (in prep).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://xp-song.github.io">Xiao Ping Song</a>, Hao Ran Lai.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
