<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single-species linear models • allometree</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single-species linear models">
<meta property="og:description" content="allometree">
<meta property="og:image" content="man/figures/logo.png">
<meta property="og:image:alt" content="Allometric Scaling of Urban Trees">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@song_xiaoping">
<meta name="twitter:site" content="https://xp-song.github.io">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-165592310-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-165592310-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">allometree</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/allometree.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/single-species_models.html">Single-species linear models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xp-song/allometree/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Single-species linear models</h1>
            
            <h4 class="date">2020-05-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xp-song/allometree/blob/master/vignettes/single-species_models.Rmd"><code>vignettes/single-species_models.Rmd</code></a></small>
      <div class="hidden name"><code>single-species_models.Rmd</code></div>

    </div>

    
    
<hr>
<div id="section1" class="section level2">
<h2 class="hasAnchor">
<a href="#section1" class="anchor"></a>1. Model selection</h2>
<p>In this document, we are using relationship between two size parameters as an example: Predicting tree <em>height</em> from trunk <em>diameter</em>. See the vignette <a href="allometree.html">Get started with allometree</a> for a full description of the dataset and allometric equations.</p>
<div id="for-one-species" class="section level3">
<h3 class="hasAnchor">
<a href="#for-one-species" class="anchor"></a>For one species</h3>
<p>For a particular species of interest, data will be fit to all allometric equations. The best-fit model is selected based on the lowest bias-corrected Aikaike’s information criterion (AICc) value. Here’s an example to select the best-fit model for the species <em>Albizia saman</em>, using the function <code>sp_modelselect()</code>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">urbantrees</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"allometree"</span>)

<span class="no">Alb_sam</span> <span class="kw">&lt;-</span> <span class="no">urbantrees</span>[<span class="no">urbantrees</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Albizia saman"</span>, ]  <span class="co"># subset data for one species</span>

<span class="no">results</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelselect</span>(<span class="no">Alb_sam</span>,
                          <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)  <span class="co"># specify colnames of variables</span></pre></body></html></div>
<p><code>results</code> is a list of 3 elements. More information on the output can be found at <code>?sp_modelselect</code>.</p>
<ol style="list-style-type: decimal">
<li>Table showing models ranked by AICc value, named <code>all_models_rank</code>.</li>
<li>Best-fit model object, named <code>best_model</code>.</li>
<li>Table showing information on the best-fit model, named <code>best_model_info</code>.</li>
</ol>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">results</span>$<span class="no">all_models_rank</span>)
<span class="co">#&gt;   df     AICc    model</span>
<span class="co">#&gt; 1  3 591.9422   lin_w1</span>
<span class="co">#&gt; 2  4 593.0074  quad_w1</span>
<span class="co">#&gt; 3  5 593.4045   cub_w1</span>
<span class="co">#&gt; 4  6 594.0030 quart_w1</span>
<span class="co">#&gt; 5  3 594.0139   lin_w2</span>
<span class="co">#&gt; 6  5 595.5983   cub_w2</span></pre></body></html></div>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">results</span>$<span class="no">best_model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = y ~ x)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)            x  </span>
<span class="co">#&gt;       6.717        9.464</span></pre></body></html></div>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">results</span>$<span class="no">best_model_info</span>
<span class="co">#&gt;   modelcode        a        b  c  d  e response_geom_mean correctn_factor</span>
<span class="co">#&gt; 1    lin_w1 6.717431 9.464096 NA NA NA           13.56608               1</span>
<span class="co">#&gt;   predictor_min predictor_max response_min response_max residual_SE mean_SE</span>
<span class="co">#&gt; 1     0.3119437      1.527887            8           20       2.205  4.7889</span>
<span class="co">#&gt;   adj_R2   n</span>
<span class="co">#&gt; 1 0.4276 133</span></pre></body></html></div>
</div>
<div id="for-multiple-species" class="section level3">
<h3 class="hasAnchor">
<a href="#for-multiple-species" class="anchor"></a>For multiple species</h3>
<p>We can also run <code>sp_modelselect()</code> across multiple species in the full dataset <code>urbantrees</code>. For this, we use the wrapper function <code>sp_modelselect_multi()</code>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">results_all</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelselect_multi</span>(<span class="no">urbantrees</span>, <span class="kw">species</span> <span class="kw">=</span> <span class="st">"species"</span>, <span class="co"># specify colname of species</span>
                                    <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)</pre></body></html></div>
<p><code>results_all</code> is a list of 3 elements:</p>
<ol style="list-style-type: decimal">
<li>List of tables showing each species’ candidate models ranked by AICc value, named <code>sp_models_rank</code>.</li>
<li>List of each species’ best-fit model object, named <code>sp_models</code>.</li>
<li>Table showing each species’ best-fit model information, named <code>sp_models_info</code>.</li>
</ol>
<p> </p>
<p>An overview of the best-fit models across the 5 species:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">results_all</span>$<span class="no">sp_models_info</span>
<span class="co">#&gt;                    species modelcode         a          b          c        d</span>
<span class="co">#&gt; 1            Albizia saman    lin_w1  6.717431   9.464096         NA       NA</span>
<span class="co">#&gt; 2            Hopea odorata  quart_w4 -1.149669 149.317848 -1522.6122 7908.410</span>
<span class="co">#&gt; 3     Syzygium myrtifolium  quart_w2 -4.614100 158.512849  -748.2492 1638.676</span>
<span class="co">#&gt; 4       Terminalia mantaly   expo_w1 10.461310  29.320921         NA       NA</span>
<span class="co">#&gt; 5 Xanthostemon chrysanthus loglog_w1 15.955007   2.982932         NA       NA</span>
<span class="co">#&gt;            e response_geom_mean correctn_factor predictor_min predictor_max</span>
<span class="co">#&gt; 1         NA          13.566083        1.000000    0.31194369     1.5278875</span>
<span class="co">#&gt; 2 -14225.442           5.390829        1.000000    0.03183099     0.2928451</span>
<span class="co">#&gt; 3  -1321.221           7.735643        1.000000    0.04138029     0.5665916</span>
<span class="co">#&gt; 4         NA           7.596013        1.031243    0.03501409     0.5602254</span>
<span class="co">#&gt; 5         NA           5.067462        1.028603    0.02864789     0.3533240</span>
<span class="co">#&gt;   response_min response_max residual_SE mean_SE adj_R2   n</span>
<span class="co">#&gt; 1            8           20      2.2050  4.7889 0.4276 133</span>
<span class="co">#&gt; 2            2           15     11.9430  2.6339 0.5460 483</span>
<span class="co">#&gt; 3            1           18      2.1674  2.2536 0.6662 353</span>
<span class="co">#&gt; 4            3           18      1.8938  3.5502 0.6702 197</span>
<span class="co">#&gt; 5            2           43      1.2064  1.4484 0.5551 419</span></pre></body></html></div>
</div>
</div>
<div id="outlier-removal" class="section level2">
<h2 class="hasAnchor">
<a href="#outlier-removal" class="anchor"></a>2. Outlier removal</h2>
<p>Let’s say we want to check for outlier/influential data points, remove them, and re-fit the filtered dataset to the pre-selected models as defined in <code>results_all$sp_models_info</code>. First, lets visualise these outliers, say, for the species <em>Xanthostemon chrysanthus</em>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">2</span>)); <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">results_all</span>$<span class="no">sp_models</span>$<span class="no">`Xanthostemon chrysanthus`</span>)</pre></body></html></div>
<p><img src="single-species_models_files/figure-html/unnamed-chunk-8-1.png" width="528" style="display: block; margin: auto;">  </p>
<p>There are numerous ways to <a href="http://r-statistics.co/Outlier-Treatment-With-R.html">deal with outliers</a>. One way is to remove them based on Cook’s Distance (bottom-right plot). In general use, outliers may be defined as points with a Cook’s distance more than four times the mean Cook’s distance (red line in plot below). Note that this threshold is not fixed, and may be adjusted according to biological knowledge of each tree species.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">cooks_dist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">cooks.distance</a></span>(<span class="no">results_all</span>$<span class="no">sp_models</span>$<span class="no">`Xanthostemon chrysanthus`</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">cooks_dist</span>, <span class="kw">pch</span> <span class="kw">=</span> <span class="st">"."</span>, <span class="kw">cex</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="st">"Outliers by Cook's Distance"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="fl">4</span> * <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">T</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>)  <span class="co"># threshold line </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">cooks_dist</span>) + <span class="fl">1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cooks_dist</span>,
     <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">cooks_dist</span> <span class="kw">&gt;</span> <span class="fl">4</span> * <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="no">T</span>), <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">cooks_dist</span>), <span class="st">""</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>)  <span class="co"># outlier labels</span></pre></body></html></div>
<p><img src="single-species_models_files/figure-html/unnamed-chunk-9-1.png" width="384" style="display: block; margin: auto;"></p>
<p> </p>
<p>Lets remove outliers across all species in <code>urbantrees</code>. We can create a function <code>uncooker()</code> that does so for each species using a <code>for()</code> loop, based on their respective best-fit model in <code>results_all$sp_models</code>:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">uncooker</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">modellist</span>){

  <span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">data</span>[<span class="fl">0</span>,]

  <span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">modellist</span>)){ <span class="co"># loop over all species </span>

    <span class="no">cooks_dist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">cooks.distance</a></span>(<span class="no">modellist</span><span class="kw">[[</span><span class="no">i</span>]])
    <span class="no">outliers</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">cooks_dist</span> <span class="kw">&gt;</span> <span class="fl">4</span> * <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cooks_dist</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="no">T</span>)))  <span class="co"># threshold</span>
    <span class="no">subset</span> <span class="kw">&lt;-</span> <span class="no">data</span>[(<span class="no">data</span>$<span class="no">species</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">modellist</span>[<span class="no">i</span>])),][-<span class="no">outliers</span>,]
    <span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind.data.frame</a></span>(<span class="no">result</span>, <span class="no">subset</span>)
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">result</span>)
}

<span class="co"># run the function uncooker()</span>
<span class="no">urbantrees_clean</span> <span class="kw">&lt;-</span> <span class="fu">uncooker</span>(<span class="no">urbantrees</span>, <span class="no">results_all</span>$<span class="no">sp_models</span>)

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">urbantrees_clean</span>)
<span class="co">#&gt; [1] 1526</span></pre></body></html></div>
<p>59 data points were removed to obtain the filtered dataset <code>urbantrees_clean</code> (n = 1526).</p>
</div>
<div id="re-fit-filtered-data" class="section level2">
<h2 class="hasAnchor">
<a href="#re-fit-filtered-data" class="anchor"></a>3. Re-fit filtered data</h2>
<div id="for-one-species-1" class="section level3">
<h3 class="hasAnchor">
<a href="#for-one-species-1" class="anchor"></a>For one species</h3>
<p>We can now fit <code>urbantrees_clean</code> to the best-fit equations we defined in <a href="#section1">Section 1</a>. Here’s an example for the species <em>Albizia saman</em> again, using the function <code>sp_modelfit()</code>. This function has an additional argument <code>modelcode</code>. In the case of <em>Albizia saman</em>, it is <code>lin_w1</code> (see <code>results_all$sp_models_info</code>). Note that you can also pick any one of the options found in <code>eqns_info$modelcode</code>.</p>
<p> </p>
<p>We’ll overwrite our previously-defined variables <code>Alb_sam</code> and <code>results</code>, this time with the filtered dataset:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">Alb_sam</span> <span class="kw">&lt;-</span> <span class="no">urbantrees_clean</span>[<span class="no">urbantrees_clean</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Albizia saman"</span>, ]

<span class="no">results</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelfit</span>(<span class="no">Alb_sam</span>, <span class="kw">modelcode</span> <span class="kw">=</span> <span class="st">"lin_w1"</span>, <span class="co"># specify modelcode</span>
                       <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)</pre></body></html></div>
<p><code>results</code> is now a list of 2 elements:</p>
<ol style="list-style-type: decimal">
<li>Resulting model object, named <code>fitted_model</code>.</li>
<li>Table showing information on the resulting model, named <code>fitted_model_info</code>.</li>
</ol>
</div>
<div id="for-multiple-species-1" class="section level3">
<h3 class="hasAnchor">
<a href="#for-multiple-species-1" class="anchor"></a>For multiple species</h3>
<p>Similar to the the wrapper function <code>sp_modelselect_multi()</code>, we can also run <code>sp_modelfit_multi()</code> to fit pre-selected models across multiple species. In this function, we need to input a reference table <code>ref_table</code> (i.e. <code>results_all$sp_models_info</code>) that provides information on the <code>species</code> and their corresponding <code>modelcode</code>.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">results_all</span> <span class="kw">&lt;-</span> <span class="fu">sp_modelfit_multi</span>(<span class="no">urbantrees_clean</span>,
                                 <span class="kw">ref_table</span> <span class="kw">=</span> <span class="no">results_all</span>$<span class="no">sp_models_info</span>,
                                 <span class="kw">species</span> <span class="kw">=</span> <span class="st">"species"</span>, <span class="co"># colname in both data &amp; ref_table</span>
                                 <span class="kw">modelcode</span> <span class="kw">=</span> <span class="st">"modelcode"</span>, <span class="co"># colname in ref_table</span>
                                 <span class="kw">response</span> <span class="kw">=</span> <span class="st">"height"</span>, <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"diameter"</span>)</pre></body></html></div>
<p><code>results_all</code> is now a list of 2 elements:</p>
<ol style="list-style-type: decimal">
<li>List of each species’ resulting model object, named <code>sp_models</code>.</li>
<li>Table showing each species’ resulting model information, named <code>sp_models_info</code>.</li>
</ol>
<p> </p>
<p>To make our subsequent code less verbose, let’s assign the elements <code>sp_models</code> and <code>sp_models_info</code> to variables with the same name:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">sp_models</span> <span class="kw">&lt;-</span> <span class="no">results_all</span>$<span class="no">sp_models</span>
<span class="no">sp_models_info</span> <span class="kw">&lt;-</span> <span class="no">results_all</span>$<span class="no">sp_models_info</span></pre></body></html></div>
</div>
</div>
<div id="make-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#make-predictions" class="anchor"></a>4. Make predictions</h2>
<p>We can simulate some data for a species of interest, and use it’s model to make predictions. We’ll use the species <em>Albizia saman</em> again as an example. Let’s first simulate the data, based on the range of values for the predictor variable (i.e. diameter size) that was used to fit the model:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">predict_range</span> <span class="kw">&lt;-</span> <span class="no">sp_models_info</span>[<span class="no">sp_models_info</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Albizia saman"</span>,]

<span class="co"># simulate 100 data points across range</span>
<span class="no">predict_range_full</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">predict_range</span>, <span class="fl">1</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="no">x</span>[<span class="st">"predictor_min"</span>], <span class="no">x</span>[<span class="st">"predictor_max"</span>], <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">predict_range_full</span>) <span class="kw">&lt;-</span> <span class="no">predict_range</span>$<span class="no">species</span>

<span class="no">predict_range_full</span> <span class="kw">&lt;-</span> <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="no">predict_range_full</span>,
                                          <span class="kw">cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">predict_range_full</span>),
                                          <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"species"</span>, <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"predictor"</span>)</pre></body></html></div>
<p> </p>
<p><code>sp_predict()</code> can be used to make predictions on the simulated data <code>predict_range_full</code>. This appends columns for predicted height (<code>fit</code>), as well as the lower (<code>lwr</code>) and upper (<code>upr</code>) bounds of the prediction interval:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu">sp_predict</span>(<span class="no">predict_range_full</span>,
                          <span class="kw">models</span> <span class="kw">=</span> <span class="no">sp_models</span>,
                          <span class="kw">ref_table</span> <span class="kw">=</span> <span class="no">sp_models_info</span>,
                          <span class="kw">predictor</span> <span class="kw">=</span> <span class="st">"predictor"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">predictions</span>)
<span class="co">#&gt;         species predictor      fit      lwr      upr</span>
<span class="co">#&gt; 1 Albizia saman 0.3119437 9.011007 4.679395 13.34262</span>
<span class="co">#&gt; 2 Albizia saman 0.3211393 9.111607 4.783827 13.43939</span>
<span class="co">#&gt; 3 Albizia saman 0.3303349 9.212208 4.888182 13.53623</span>
<span class="co">#&gt; 4 Albizia saman 0.3395306 9.312808 4.992459 13.63316</span>
<span class="co">#&gt; 5 Albizia saman 0.3487262 9.413409 5.096658 13.73016</span>
<span class="co">#&gt; 6 Albizia saman 0.3579218 9.514010 5.200779 13.82724</span></pre></body></html></div>
<p> </p>
<p>Note that you can simulate data automatically using the <code>sp_simulate()</code> function, which is also a wrapper to <code>sp_predict()</code>. This can be done for one or multiple species, using the argument <code>select_sp</code>. The simulated data can be extrapolated beyond the range used to fit the model, using the argument <code>extrapolate</code>. Here’s an example using the models that we previously derived from the filtered dataset <code>urbantrees_clean</code>. Let’s say we’re interested in <em>Albizia saman</em>, <em>Terminalia mantaly</em>, and <em>Xanthostemon chrysanthus</em>, and would like to predict their height across a diameter size of 0 – 1 m. We’ll overwrite our previously-defined variable <code>predictions</code>:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu">sp_simulate</span>(<span class="kw">ref_table</span> <span class="kw">=</span> <span class="no">sp_models_info</span>, <span class="kw">models</span> <span class="kw">=</span> <span class="no">sp_models</span>,
                           <span class="kw">select_sp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Albizia saman"</span>, <span class="st">"Terminalia mantaly"</span>, <span class="st">"Xanthostemon chrysanthus"</span>),
                           <span class="kw">extrapolate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">predictions</span>)
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt; # Groups:   species [1]</span>
<span class="co">#&gt;   species       predictor   fit   lwr   upr extrapolated</span>
<span class="co">#&gt;   &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       </span>
<span class="co">#&gt; 1 Albizia saman     0.312  9.01  4.68  13.3 No          </span>
<span class="co">#&gt; 2 Albizia saman     0.321  9.11  4.78  13.4 No          </span>
<span class="co">#&gt; 3 Albizia saman     0.330  9.21  4.89  13.5 No          </span>
<span class="co">#&gt; 4 Albizia saman     0.340  9.31  4.99  13.6 No          </span>
<span class="co">#&gt; 5 Albizia saman     0.349  9.41  5.10  13.7 No          </span>
<span class="co">#&gt; 6 Albizia saman     0.358  9.51  5.20  13.8 No</span></pre></body></html></div>
</div>
<div id="plot-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-predictions" class="anchor"></a>5. Plot predictions</h2>
<p>We can plot out our predictions using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">species</span>)+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">urbantrees</span>, <span class="no">species</span> <span class="kw">%in%</span> <span class="no">predictions</span>$<span class="no">species</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">diameter</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">height</span>),
             <span class="kw">size</span><span class="kw">=</span><span class="fl">0.35</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.9</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"grey50"</span>) +

  <span class="co"># prediction interval</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">predictions</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">predictor</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lwr</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upr</span>),
              <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.10</span>) +

  <span class="co"># regression line</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">predictions</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">predictor</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">fit</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="no">extrapolated</span>),
            <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.8</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.6</span>) +

  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(<span class="kw">values</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"No"</span><span class="kw">=</span> <span class="fl">1</span> , <span class="st">"Low"</span> <span class="kw">=</span> <span class="fl">3</span>, <span class="st">"High"</span> <span class="kw">=</span> <span class="fl">3</span>), <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Extrapolated"</span>) +

  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Diameter (m)"</span>) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Height (m)"</span>) +

  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="kw">ylim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">25</span>), <span class="kw">xlim</span><span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))</pre></body></html></div>
<p><img src="single-species_models_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;"></p>
<p> </p>
<p>Interpretations of the allometric relationships will vary depending on what type of parameter is analysed (e.g. tree height, trunk diameter, age, crown height, crown diameter and leaf area). In our example, we’ll have to be cautious in interpretating extrapolated predictions. As you can see in the figure, extrapolations down to a diameter size of zero for <em>Albizia saman</em> and <em>Terminalia mantaly</em> would not make sense (i.e. the tree cannot have a positive height at that diameter size). Also, while an exponential relationship shows rapid scaling in height for <em>Terminalia mantaly</em>, it would have a natural height limit (i.e. would not continue growing taller at such a steep slope). Hence, it is important that allometric relationships are interpreted in conjunction with information on the biology and growth (e.g. environmental and management) conditions associated with the trees.</p>
<hr>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>McPherson E. G., van Doorn N. S. &amp; Peper P. J. (2016) Urban Tree Database and Allometric Equations. <em>General Technical Report PSW-GTR-253, USDA Forest Service</em>, 86.</p>
<p>Song, X. P., Lai, H. R., Wijedasa, L. S., Yee, A. T. K., Tan, P. Y., Richards, D. R., Streamlining management practices based on the size allometry of tropical street trees (in prep).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://xp-song.github.io">Xiao Ping Song</a>, Hao Ran Lai.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
