---
title: "Get started with allometree"
author: 
date: "`r Sys.Date()`"
opengraph:
  image: 
    src: "man/figures/logo.png"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started with allometree}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, warning = FALSE
)
```

```{r include = FALSE, eval = F}
devtools::load_all() # if don't want to use installed version
```

```{r include = FALSE, eval = T}
library(allometree) # if installed (FOR TRAVIS CI)
```


The `allometree` package enables you to develop and use allometric equations relating to the size and structure of urban trees. For example, these equations have been used to predict trunk diameter from tree age, as well as to predict tree height, crown height, crown diameter and leaf area from trunk diameter. They are foundational to other models that estimate the benefits and hazards associated with trees as they mature and grow in size. More information can be found in Song *et al.* (in prep).  

This document demonstrates the workflow to develop these allometric models, taking the relationship between two size parameters as an example: Predicting tree *height* from trunk *diameter*. 

Two linear modelling approaches will be introduced:  

  1. Regression models developed separately for each species, i.e., *single-species models*
  2. Mixed-effects model that includes all species as random effects, i.e., *mixed-effects model*


## Example data: `urbantrees`

We will be using `data(urbantrees)`. It contains five species planted along streets in Singapore, each spanning a wide range of heights and diameter sizes (in metres).

```{r load data, fig.width=5.5, fig.align='center'}
data(urbantrees, package = "allometree")
urbantrees

library(ggplot2)
ggplot(urbantrees, aes(diameter, height)) +
  facet_wrap(~ species, scales = "free") +
  geom_point()
```


## Allometric equations: `eqns_info`

Allometric relationships for urban trees can vary drastically from those for forest trees, and are also influenced by human factors such as pruning and fertilisation. Empirical models are developed using six allometric equations used for urban trees (McPherson *et al.*, 2016). 

More information can be found in `?eqns_info`, as well as in `data(eqns_info)`. The column `modelcode` shows the unique model code for each equation:

```{r eqns_info}
data(eqns_info, package = "allometree")
head(eqns_info)
```

---

## 1. Single-species models

We can run `sp_modelselect_multi()` to select the best-fit model for each species in the dataset `urbantrees`. This can also be done for  individual species using `sp_modelselect()`. 

```{r}
results <- sp_modelselect_multi(urbantrees, species = "species", # specify colname of species
                                response = "height", predictor = "diameter") # specify colnames of variables
```

The `results` variable is a list of 3 elements:

1. List of tables showing each species' candidate models ranked by AICc value, named `sp_models_rank`.
2. List of each species' best-fit model object, named `sp_models`.
3. Table showing each species' best-fit model information, named `sp_models_info`. 

&nbsp;

Note that you can also fit data to specified (i.e. pre-defined) equations, using the functions `sp_modelfit()` and `sp_modelfit_multi()`. This can be done, for example, after the removal of outliers from the full dataset. See the vignette 
[Single-species linear models](single-species_models.html) for a full demonstration.

&nbsp;

An overview of the best-fit models across the `r nrow(results$sp_models_info)` species:
```{r}
results$sp_models_info
```

&nbsp;



---

## 2. Mixed-effects model

In the works...


---

## References

McPherson E. G., van Doorn N. S. & Peper P. J. (2016) Urban Tree Database and Allometric Equations. *General Technical Report PSW-GTR-253, USDA Forest Service*, 86.

Song, X. P., Lai, H. R., Wijedasa, L. S., Yee, A. T. K., Tan, P. Y., Richards, D. R., Streamlining management practices based on the size allometry of tropical street trees (in prep).

