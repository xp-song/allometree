---
title: "Get started with allometree"
author: 
date: "`r Sys.Date()`"
opengraph:
  image: 
    src: "man/figures/logo.png"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started with allometree}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, warning = FALSE
)
```

```{r include = FALSE, eval = T}
library(allometree)
#devtools::load_all() # to knit manually
```


The `allometree` package enables you to develop and use allometric equations relating to the size and structure of urban trees. For example, these equations have been used to predict trunk diameter from tree age, as well as to predict tree height, crown height, crown diameter and leaf area from trunk diameter. They are foundational to other models that estimate the benefits and hazards associated with trees as they mature and grow in size.

This document demonstrates the workflow to develop these allometric models, taking the relationship between two size parameters as an example: Predicting tree *height* from trunk *diameter*. 

Two linear modelling approaches will be introduced:  

  1. Regression models developed separately for each species, i.e., *single-species models*
  2. Mixed-effects model that includes all species as random effects, i.e., *mixed-effects model*


## Example data: `urbantrees`

We will be using `data(urbantrees)`. It contains five species planted along streets in Singapore, each spanning a wide range of heights and diameter sizes (in metres).

```{r load data, fig.width=5.5, fig.align='center'}
data(urbantrees, package = "allometree")
urbantrees

library(ggplot2)

ggplot(urbantrees, aes(diameter, height)) +
  facet_wrap(~ species, scales = "free") +
  geom_point()
```


## Allometric equations: `eqns_info`

Allometric relationships for urban trees can vary drastically from those for forest trees, and are also influenced by human factors such as pruning and fertilisation. Empirical models are developed using six allometric equations used for urban trees (McPherson *et al.*, 2016). 

More information can be found in `?eqns_info`, as well as in `data(eqns_info)`. The column `modelcode` shows the unique model code for each equation:

```{r eqns_info}
data(eqns_info, package = "allometree")
head(eqns_info)
```

---

## 1. Single-species models

We can run `sp_modelselect_multi()` to select the best-fit model for each species in the dataset `urbantrees`. This can also be done for  individual species using `sp_modelselect()`. Note that you can also fit data to specified (i.e. pre-defined) equations, using the functions `sp_modelfit()` and `sp_modelfit_multi()`. This can be done, for example, after the removal of outliers from the full dataset. See the vignette [Single-species linear models](single-species_models.html) for a full demonstration.

```{r}
results <- sp_modelselect_multi(urbantrees, species = "species", # specify colname of species
                                response = "height", predictor = "diameter") # specify colnames of variables
```

`results` is a list of 3 elements:

1. List of tables showing each species' candidate models ranked by AICc value, named `sp_models_rank`.
2. List of each species' best-fit model object, named `sp_models`.
3. Table showing each species' best-fit model information, named `sp_models_info`. 

&nbsp;

An overview of the best-fit models across the `r nrow(results$sp_models_info)` species:
```{r}
results$sp_models_info
```

&nbsp;

We can simulate data across a range of diameter sizes for each species, and use their respective models to make predictions of tree height. The simulated data can also be extrapolated beyond the range used to fit the model, using the argument `extrapolate`:

```{r}
predictions <- sp_simulate(ref_table = results$sp_models_info, models = results$sp_models,
                           extrapolate = c(0,1))
head(predictions)
```

&nbsp;

`predictions` is a dataframe of simulated data for the diameter size (`predictor`) for each `species`. Other columns include the predicted height (`fit`), the lower (`lwr`) and upper (`upr`) bounds of the prediction interval, as well as whether the height/diameter variables are `extrapolated` beyond the original data used to fit the model.

---

## 2. Mixed-effects model

In the works...

---

## 3. Comparision between model types

In the works...

```{r eval = FALSE, include = FALSE}

ggplot() +
  facet_wrap(~ species)+ 
  geom_point(data = urbantrees, aes(x = diameter, y = height),
             size=0.35, alpha = 0.9, color = "grey50") +
  
  # prediction interval
  geom_ribbon(data = predictions, aes(x = predictor, ymin = lwr, ymax = upr), 
              alpha = 0.10) +
  
  # regression line
  geom_line(data = predictions, aes(x = predictor, y = fit, lty = extrapolated),
            size = 0.8, alpha = 0.6) +
  
  scale_linetype_manual(values=c("No"= 1 , "Low" = 3, "High" = 3), name = "Extrapolated") +
  
  xlab("Diameter (m)") + ylab("Height (m)") +
  
  coord_cartesian(ylim=c(0, 25), xlim= c(0,max(predictions$predictor)))
```


---

## References

McPherson E. G., van Doorn N. S. & Peper P. J. (2016) Urban Tree Database and Allometric Equations. *General Technical Report PSW-GTR-253, USDA Forest Service*, 86.

Song, X. P., Lai, H. R., Wijedasa, L. S., Yee, A. T. K., Tan, P. Y., Richards, D. R., Streamlining management practices based on the size allometry of tropical street trees (in prep).

