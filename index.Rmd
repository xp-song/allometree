---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/"
)
```

# Allometric Scaling of Urban Trees 
<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

<a href='https://xp-song.github.io/allometree/'><img src='man/figures/logo.png' align="right" height="175" /></a>

Develop and use allometric equations relating to the size and structure of urban trees. Refer to [package website](https://xp-song.github.io/allometree/) and [prototype web app](https://xpsong.shinyapps.io/allometree-sg/) for demonstrations of how the package may be used. The package supplements the following study:  

Song, X. P., Lai, H. R., Wijedasa, L. S., Tan, P. Y., Edwards, P. J., & Richards, D. R., Heightâ€“diameter allometry for the management of city trees in the tropics (in review). 

## Installation

```{r, eval = FALSE}
# Install development version from GitHub
devtools::install_github("xp-song/allometree")
```

## Setup

```{r eval = FALSE}
library(allometree)
```

```{r include = FALSE, eval = TRUE}
devtools::load_all() # to knit manually
```


## Example

Allometric equations in this package have been used to predict relationships between parameters related tree size and structure, such as age, height, trunk diameter, crown height, crown diameter, leaf area, etc. They are foundational to other models that estimate the benefits and hazards associated with trees as they mature and grow in size. See the vignette '[Get started with allometree](articles/allometree.html)' for a full description of example datasets and allometric equations.

Let's develop models to predict tree *height* from trunk *diameter* for five species in our example dataset `data(urbantrees)`:

```{r urbantrees, fig.width=5.5, fig.height=4, fig.align='center', echo = FALSE}
data(urbantrees, package = "allometree")
library(ggplot2)
ggplot(urbantrees, aes(diameter, height)) +
  facet_wrap(~ species) +
  geom_point(size=0.35, alpha = 0.9, color = "grey50") +
  coord_cartesian(ylim=c(0, 25), xlim= c(0,1)) +
  xlab("Diameter (m)") + ylab("Height (m)")
```

&nbsp;

One method is to develop allometric models separately for each species, i.e., [single-species linear models](articles/single-species_models.html). We can select the best-fit equation for each species in the dataset, or fit data to specified (i.e. pre-defined) equations, for example, after the removal of outliers. The example below selects the best-fit equation for each species in `urbantrees`:

```{r}
results <- ss_modelselect_multi(urbantrees, species = "species", # specify colname of species
                                response = "height", predictor = "diameter") # specify colnames of variables

```

&nbsp;

We can simulate data across a range of diameter sizes for each species, and use their respective models to make predictions of tree height. The simulated data can also be extrapolated beyond the range used to fit the model:

```{r}
predictions <- ss_simulate(ref_table = results$ss_models_info, models = results$ss_models, 
                           extrapolate = c(0,1)) # diameter from 0 to 1 m

```

&nbsp;

Model predictions can be visualised alongside the original data using `ggplot2::ggplot()`:

```{r single-species_model_curves, message = FALSE, warning = FALSE, fig.width=6.5, fig.height =4, fig.align='center', echo = FALSE}
library(ggplot2)

ggplot() +
  facet_wrap(~ species)+ 
  geom_point(data = urbantrees, aes(x = diameter, y = height),
             size=0.35, alpha = 0.9, color = "grey50") +
  
  # prediction interval
  geom_ribbon(data = predictions, aes(x = predictor, ymin = lwr, ymax = upr), 
              alpha = 0.10) +
  
  # regression line
  geom_line(data = predictions, aes(x = predictor, y = fit, lty = extrapolated),
            size = 0.8, alpha = 0.6) +
  
  scale_linetype_manual(values=c("No"= 1 , "Low" = 3, "High" = 3), name = "Extrapolated") +
  
  xlab("Diameter (m)") + ylab("Height (m)") +
  
  coord_cartesian(ylim=c(0, 25), xlim= c(0,1))
```

&nbsp;

These allometric relationships can then be interpreted in conjunction with information on the biology and growth (e.g. environmental and management) conditions associated with the trees.
